default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    require 'base64'
    # Recreate API key file from base64 to avoid storing p8 in repo
    p8_base64 = ENV["ASC_KEY_P8_BASE64"]
    key_path = File.join(Dir.pwd, "fastlane", "asc_key.p8")
    if p8_base64 && !p8_base64.empty?
      File.open(key_path, "wb") { |f| f.write(Base64.decode64(p8_base64)) }
    end

    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: key_path,
      is_key_content_base64: false
    )

    # Ensure signing (you can switch to manual signing if preferred)
    if ENV["MATCH_GIT_URL"] && !ENV["MATCH_GIT_URL"].empty?
      match(type: "appstore", readonly: true, api_key: api_key)
    end

    build_app(
      scheme: ENV["XCODE_SCHEME"] || "App",
      export_method: "app-store",
      output_directory: "fastlane/build",
      include_bitcode: false
    )
    upload_to_testflight(
      api_key: api_key,
      groups: (ENV["TESTFLIGHT_GROUPS"] || "internal testers")
    )
  end

  desc "Build ipa and upload to Firebase App Distribution"
  lane :firebase_beta do
    # Optional: use match for ad-hoc signing
    if ENV["MATCH_GIT_URL"] && !ENV["MATCH_GIT_URL"].empty?
      match(type: "adhoc", readonly: true)
    end
    build_app(
      scheme: ENV["XCODE_SCHEME"] || "App",
      export_method: "ad-hoc",
      output_directory: "fastlane/build",
      include_bitcode: false
    )
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_IOS"],
      groups: ENV["FIREBASE_GROUPS"] || "internal-testers",
      release_notes: ENV["RELEASE_NOTES"] || "Automated iOS build from TeamCity",
      firebase_cli_token: ENV["FIREBASE_TOKEN"],
      ipa_path: Dir["fastlane/build/*.ipa"].first
    )
  end
end

platform :android do
  desc "Build Android release and upload to Firebase App Distribution"
  lane :firebase_beta do
    # Ensure Gradle executable (prefer wrapper; else absolute system gradle)
    project_dir = "."
    wrapper_path = File.join(project_dir, "gradlew")
    gradle_exec = nil
    if File.exist?(wrapper_path)
      begin
        sh("chmod +x \"#{wrapper_path}\"")
      rescue => e
        UI.message("chmod gradlew skipped: #{e}")
      end
      gradle_exec = wrapper_path
    else
      which_out = sh("which gradle || true").to_s.strip
      if which_out.empty?
        UI.user_error!("Gradle wrapper not found and system 'gradle' not available. Add gradlew to your repo or install Gradle on the agent.")
      end
      gradle_exec = which_out
    end

    # Optional: inject signing via Gradle properties if your project reads them
    signing_props = {}
    if ENV["ANDROID_KEYSTORE_PATH"] && !ENV["ANDROID_KEYSTORE_PATH"].empty?
      signing_props["android.injected.signing.store.file"] = ENV["ANDROID_KEYSTORE_PATH"]
    end
    if ENV["ANDROID_KEYSTORE_PASSWORD"] && !ENV["ANDROID_KEYSTORE_PASSWORD"].empty?
      signing_props["android.injected.signing.store.password"] = ENV["ANDROID_KEYSTORE_PASSWORD"]
    end
    if ENV["ANDROID_KEY_ALIAS"] && !ENV["ANDROID_KEY_ALIAS"].empty?
      signing_props["android.injected.signing.key.alias"] = ENV["ANDROID_KEY_ALIAS"]
    end
    if ENV["ANDROID_KEY_PASSWORD"] && !ENV["ANDROID_KEY_PASSWORD"].empty?
      signing_props["android.injected.signing.key.password"] = ENV["ANDROID_KEY_PASSWORD"]
    end

    gradle(task: "clean", project_dir: project_dir, gradle_path: gradle_exec)
    gradle(
      task: ":composeApp:assembleRelease",
      project_dir: project_dir,
      properties: signing_props,
      gradle_path: gradle_exec
    )

    # Prefer APK, fallback to AAB; support common module names (composeApp, app)
    artifact = ENV["ANDROID_ARTIFACT_PATH"] ||
               Dir["composeApp/build/outputs/apk/release/*.apk"].first ||
               Dir["app/build/outputs/apk/release/*.apk"].first ||
               Dir["composeApp/build/outputs/bundle/release/*.aab"].first ||
               Dir["app/build/outputs/bundle/release/*.aab"].first
    unless artifact
      UI.user_error!("Could not find Android release artifact (APK/AAB)")
    end

    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"] || ENV["ANDROID_FIREBASE_APP_ID"],
      groups: ENV["FIREBASE_GROUPS"] || "internal-testers",
      release_notes: ENV["RELEASE_NOTES"] || "Automated Android build from TeamCity",
      firebase_cli_token: ENV["FIREBASE_TOKEN"],
      android_artifact_path: artifact
    )
  end
end
